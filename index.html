<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL Query Visualizer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #60a5fa 100%);
            min-height: 100vh;
            padding: 20px;
            color: #1f2937;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 1.2em;
            opacity: 0.95;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }

        .panel-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #1f2937;
        }

        textarea {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.95em;
            resize: vertical;
            transition: border-color 0.3s;
        }

        textarea:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.95em;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            justify-content: center;
            margin: 5px 0;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .btn-ai {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
        }

        .btn-ai:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
        }

        .sample-queries {
            margin-top: 15px;
        }

        .sample-btn {
            padding: 10px 15px;
            background: #f3f4f6;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85em;
            text-align: left;
            width: 100%;
            margin: 5px 0;
        }

        .sample-btn:hover {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border: 1px solid #e5e7eb;
        }

        th {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            font-weight: 600;
        }

        tr:nth-child(even) {
            background: #f9fafb;
        }

        tr:hover {
            background: #e0f2fe;
        }

        .database-schema {
            display: grid;
            gap: 15px;
        }

        .schema-table {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s;
        }

        .schema-table:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }

        .schema-table-name {
            font-weight: bold;
            font-size: 1.1em;
            color: #1f2937;
            margin-bottom: 10px;
        }

        .schema-column {
            padding: 8px;
            margin: 5px 0;
            background: white;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
        }

        .error {
            background: #fee2e2;
            border: 2px solid #ef4444;
            color: #991b1b;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .success {
            background: #d1fae5;
            border: 2px solid #10b981;
            color: #065f46;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .ai-panel {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(124, 58, 237, 0.1));
            border: 2px solid rgba(139, 92, 246, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-top: 15px;
            display: none;
        }

        .ai-panel.show {
            display: block;
        }

        .ai-panel h3 {
            color: #7c3aed;
            margin-bottom: 10px;
        }

        .join-diagram {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .venn-diagram {
            text-align: center;
            padding: 20px;
            background: #f9fafb;
            border-radius: 10px;
        }

        .venn-circles {
            position: relative;
            height: 150px;
            margin: 20px 0;
        }

        .circle {
            position: absolute;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            opacity: 0.6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }

        .circle-left {
            left: 20px;
            background: #3b82f6;
        }

        .circle-right {
            right: 20px;
            background: #10b981;
        }

        .query-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: #f9fafb;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e5e7eb;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #3b82f6;
        }

        .stat-label {
            font-size: 0.9em;
            color: #6b7280;
            margin-top: 5px;
        }

        @media (max-width: 968px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üóÑÔ∏è SQL Query Visualizer</h1>
            <p class="subtitle">Learn SQL with interactive visualizations and AI explanations</p>
        </header>

        <div class="main-grid">
            <!-- Schema Panel -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">üìä Database Schema</div>
                </div>
                <div class="database-schema" id="schema"></div>
                
                <div style="margin-top: 20px;">
                    <h4 style="margin-bottom: 10px;">Sample Queries:</h4>
                    <div class="sample-queries">
                        <button class="sample-btn" onclick="loadQuery('SELECT * FROM employees')">
                            View all employees
                        </button>
                        <button class="sample-btn" onclick="loadQuery('SELECT * FROM employees WHERE salary > 60000')">
                            High earners (>60k)
                        </button>
                        <button class="sample-btn" onclick="loadQuery('SELECT employees.name, departments.dept_name FROM employees JOIN departments ON employees.dept_id = departments.id')">
                            JOIN employees & departments
                        </button>
                        <button class="sample-btn" onclick="loadQuery('SELECT dept_id, COUNT(*) as count FROM employees GROUP BY dept_id')">
                            Count by department
                        </button>
                        <button class="sample-btn" onclick="loadQuery('SELECT AVG(salary) as avg_salary FROM employees')">
                            Average salary
                        </button>
                    </div>
                </div>
            </div>

            <!-- Query Panel -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">‚úçÔ∏è SQL Query Editor</div>
                </div>
                <textarea id="queryInput" placeholder="Enter your SQL query here...
Example: SELECT * FROM employees WHERE salary > 50000">SELECT * FROM employees</textarea>
                
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px;">
                    <button class="btn btn-primary" onclick="executeQuery()">‚ñ∂Ô∏è Run Query</button>
                    <button class="btn btn-secondary" onclick="clearQuery()">üóëÔ∏è Clear</button>
                    <button class="btn btn-ai" onclick="explainQuery()">üß† AI Explain</button>
                </div>

                <div id="aiExplanation" class="ai-panel">
                    <h3>üß† AI Explanation</h3>
                    <div id="aiContent">Loading...</div>
                </div>

                <div id="message"></div>

                <!-- Query Statistics -->
                <div class="query-stats" id="queryStats" style="display: none;">
                    <div class="stat-card">
                        <div class="stat-value" id="rowCount">0</div>
                        <div class="stat-label">Rows Returned</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="execTime">0ms</div>
                        <div class="stat-label">Execution Time</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="colCount">0</div>
                        <div class="stat-label">Columns</div>
                    </div>
                </div>

                <!-- Results Table -->
                <div class="table-container" id="resultsContainer"></div>

                <!-- JOIN Visualization -->
                <div id="joinVisualization" style="display: none;">
                    <h3 style="margin-top: 30px; margin-bottom: 15px;">üîó JOIN Visualization</h3>
                    <div class="join-diagram">
                        <div class="venn-diagram">
                            <h4>INNER JOIN</h4>
                            <div class="venn-circles">
                                <div class="circle circle-left">Table A</div>
                                <div class="circle circle-right">Table B</div>
                            </div>
                            <p>Returns only matching rows from both tables</p>
                        </div>
                        <div class="venn-diagram">
                            <h4>LEFT JOIN</h4>
                            <div class="venn-circles">
                                <div class="circle circle-left" style="opacity: 0.8;">Table A</div>
                                <div class="circle circle-right" style="opacity: 0.3;">Table B</div>
                            </div>
                            <p>Returns all rows from left table + matching from right</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Sample Database
        const database = {
            employees: [
                { id: 1, name: 'Alice Johnson', dept_id: 1, salary: 75000, hire_date: '2020-01-15' },
                { id: 2, name: 'Bob Smith', dept_id: 2, salary: 65000, hire_date: '2019-03-22' },
                { id: 3, name: 'Carol White', dept_id: 1, salary: 82000, hire_date: '2018-07-10' },
                { id: 4, name: 'David Brown', dept_id: 3, salary: 55000, hire_date: '2021-05-18' },
                { id: 5, name: 'Eve Davis', dept_id: 2, salary: 70000, hire_date: '2020-09-30' },
                { id: 6, name: 'Frank Miller', dept_id: 1, salary: 90000, hire_date: '2017-11-12' },
                { id: 7, name: 'Grace Lee', dept_id: 3, salary: 58000, hire_date: '2022-02-28' }
            ],
            departments: [
                { id: 1, dept_name: 'Engineering', location: 'Building A' },
                { id: 2, dept_name: 'Marketing', location: 'Building B' },
                { id: 3, dept_name: 'Sales', location: 'Building C' }
            ],
            projects: [
                { id: 1, project_name: 'Website Redesign', dept_id: 1, budget: 100000 },
                { id: 2, project_name: 'Product Launch', dept_id: 2, budget: 150000 },
                { id: 3, project_name: 'Q4 Campaign', dept_id: 2, budget: 80000 }
            ]
        };

        // Initialize
        displaySchema();

        function displaySchema() {
            const schemaDiv = document.getElementById('schema');
            schemaDiv.innerHTML = '';

            Object.keys(database).forEach(tableName => {
                const table = database[tableName];
                const columns = table.length > 0 ? Object.keys(table[0]) : [];

                const tableDiv = document.createElement('div');
                tableDiv.className = 'schema-table';
                
                const tableNameDiv = document.createElement('div');
                tableNameDiv.className = 'schema-table-name';
                tableNameDiv.textContent = tableName;
                tableDiv.appendChild(tableNameDiv);

                columns.forEach(col => {
                    const colDiv = document.createElement('div');
                    colDiv.className = 'schema-column';
                    
                    const type = typeof table[0][col];
                    const typeStr = type === 'number' ? 'INT' : type === 'string' ? 'VARCHAR' : 'TEXT';
                    
                    colDiv.innerHTML = `<span>${col}</span><span style="color: #6b7280;">${typeStr}</span>`;
                    tableDiv.appendChild(colDiv);
                });

                schemaDiv.appendChild(tableDiv);
            });
        }

        function loadQuery(query) {
            document.getElementById('queryInput').value = query;
        }

        function clearQuery() {
            document.getElementById('queryInput').value = '';
            document.getElementById('resultsContainer').innerHTML = '';
            document.getElementById('message').innerHTML = '';
            document.getElementById('queryStats').style.display = 'none';
            document.getElementById('joinVisualization').style.display = 'none';
        }

        function executeQuery() {
            const startTime = performance.now();
            const query = document.getElementById('queryInput').value.trim().toUpperCase();
            const messageDiv = document.getElementById('message');
            const resultsDiv = document.getElementById('resultsContainer');
            const statsDiv = document.getElementById('queryStats');
            const joinVizDiv = document.getElementById('joinVisualization');
            
            messageDiv.innerHTML = '';
            resultsDiv.innerHTML = '';
            joinVizDiv.style.display = 'none';

            try {
                let results = parseAndExecuteQuery(query);
                const endTime = performance.now();
                
                if (results && results.length > 0) {
                    displayResults(results);
                    
                    // Show stats
                    statsDiv.style.display = 'grid';
                    document.getElementById('rowCount').textContent = results.length;
                    document.getElementById('execTime').textContent = `${(endTime - startTime).toFixed(2)}ms`;
                    document.getElementById('colCount').textContent = Object.keys(results[0]).length;
                    
                    // Show JOIN visualization if query contains JOIN
                    if (query.includes('JOIN')) {
                        joinVizDiv.style.display = 'block';
                    }
                    
                    messageDiv.innerHTML = `<div class="success">‚úÖ Query executed successfully! Returned ${results.length} rows.</div>`;
                } else {
                    messageDiv.innerHTML = `<div class="success">‚úÖ Query executed successfully! No rows returned.</div>`;
                    statsDiv.style.display = 'none';
                }
            } catch (error) {
                messageDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
                statsDiv.style.display = 'none';
            }
        }

        function parseAndExecuteQuery(query) {
            // Simple SQL parser (handles basic SELECT queries)
            
            // SELECT with JOIN
            if (query.includes('JOIN')) {
                return executeJoin(query);
            }
            
            // SELECT with GROUP BY
            if (query.includes('GROUP BY')) {
                return executeGroupBy(query);
            }
            
            // SELECT with aggregates (AVG, COUNT, SUM, etc.)
            if (query.match(/AVG\(|COUNT\(|SUM\(|MAX\(|MIN\(/)) {
                return executeAggregate(query);
            }
            
            // Basic SELECT
            const tableMatch = query.match(/FROM\s+(\w+)/);
            if (!tableMatch) throw new Error('Invalid query: No table specified');
            
            const tableName = tableMatch[1].toLowerCase();
            if (!database[tableName]) throw new Error(`Table '${tableName}' not found`);
            
            let data = [...database[tableName]];
            
            // WHERE clause
            const whereMatch = query.match(/WHERE\s+(.+?)(?:\s+ORDER BY|\s+LIMIT|$)/);
            if (whereMatch) {
                const condition = whereMatch[1].trim();
                data = data.filter(row => evaluateCondition(row, condition));
            }
            
            // ORDER BY
            const orderMatch = query.match(/ORDER BY\s+(\w+)(?:\s+(ASC|DESC))?/);
            if (orderMatch) {
                const field = orderMatch[1].toLowerCase();
                const order = orderMatch[2] === 'DESC' ? -1 : 1;
                data.sort((a, b) => (a[field] > b[field] ? order : -order));
            }
            
            // LIMIT
            const limitMatch = query.match(/LIMIT\s+(\d+)/);
            if (limitMatch) {
                data = data.slice(0, parseInt(limitMatch[1]));
            }
            
            // SELECT columns
            const selectMatch = query.match(/SELECT\s+(.+?)\s+FROM/);
            if (selectMatch && selectMatch[1] !== '*') {
                const columns = selectMatch[1].split(',').map(c => c.trim().toLowerCase());
                data = data.map(row => {
                    const newRow = {};
                    columns.forEach(col => {
                        if (row.hasOwnProperty(col)) newRow[col] = row[col];
                    });
                    return newRow;
                });
            }
            
            return data;
        }

        function executeJoin(query) {
            const joinMatch = query.match(/FROM\s+(\w+)\s+JOIN\s+(\w+)\s+ON\s+(\w+)\.(\w+)\s*=\s*(\w+)\.(\w+)/i);
            if (!joinMatch) throw new Error('Invalid JOIN syntax');
            
            const [, table1, table2, t1Alias, t1Col, t2Alias, t2Col] = joinMatch;
            const t1 = database[table1.toLowerCase()];
            const t2 = database[table2.toLowerCase()];
            
            if (!t1 || !t2) throw new Error('Table not found in JOIN');
            
            const results = [];
            t1.forEach(row1 => {
                t2.forEach(row2 => {
                    if (row1[t1Col] === row2[t2Col]) {
                        const joined = {};
                        Object.keys(row1).forEach(key => {
                            joined[`${table1.toLowerCase()}.${key}`] = row1[key];
                        });
                        Object.keys(row2).forEach(key => {
                            joined[`${table2.toLowerCase()}.${key}`] = row2[key];
                        });
                        results.push(joined);
                    }
                });
            });
            
            return results;
        }

        function executeGroupBy(query) {
            const match = query.match(/SELECT\s+(\w+),\s*COUNT\(\*\)\s+as\s+(\w+)\s+FROM\s+(\w+)\s+GROUP BY\s+(\w+)/i);
            if (!match) throw new Error('Invalid GROUP BY syntax');
            
            const [, groupCol, aliasName, tableName, groupBy] = match;
            const table = database[tableName.toLowerCase()];
            
            const groups = {};
            table.forEach(row => {
                const key = row[groupBy];
                groups[key] = (groups[key] || 0) + 1;
            });
            
            return Object.entries(groups).map(([key, count]) => ({
                [groupCol]: key,
                [aliasName]: count
            }));
        }

        function executeAggregate(query) {
            const avgMatch = query.match(/AVG\((\w+)\)\s+as\s+(\w+)\s+FROM\s+(\w+)/i);
            const countMatch = query.match(/COUNT\(\*\)/i);
            
            if (avgMatch) {
                const [, column, alias, tableName] = avgMatch;
                const table = database[tableName.toLowerCase()];
                const sum = table.reduce((acc, row) => acc + (row[column] || 0), 0);
                const avg = sum / table.length;
                return [{ [alias]: avg.toFixed(2) }];
            }
            
            if (countMatch) {
                const tableMatch = query.match(/FROM\s+(\w+)/i);
                const table = database[tableMatch[1].toLowerCase()];
                return [{ count: table.length }];
            }
            
            throw new Error('Unsupported aggregate function');
        }

        function evaluateCondition(row, condition) {
            // Simple condition evaluator
            const match = condition.match(/(\w+)\s*([><=!]+)\s*(.+)/);
            if (!match) return true;
            
            const [, field, operator, value] = match;
            const rowValue = row[field.toLowerCase()];
            const compareValue = isNaN(value) ? value.replace(/'/g, '') : parseFloat(value);
            
            switch (operator) {
                case '>': return rowValue > compareValue;
                case '<': return rowValue < compareValue;
                case '>=': return rowValue >= compareValue;
                case '<=': return rowValue <= compareValue;
                case '=': return rowValue == compareValue;
                case '!=': return rowValue != compareValue;
                default: return true;
            }
        }

        function displayResults(results) {
            const container = document.getElementById('resultsContainer');
            
            if (results.length === 0) {
                container.innerHTML = '<p>No results found.</p>';
                return;
            }
            
            const table = document.createElement('table');
            const thead = document.createElement('thead');
            const tbody = document.createElement('tbody');
            
            // Headers
            const headerRow = document.createElement('tr');
            Object.keys(results[0]).forEach(key => {
                const th = document.createElement('th');
                th.textContent = key;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            
            // Rows
            results.forEach(row => {
                const tr = document.createElement('tr');
                Object.values(row).forEach(value => {
                    const td = document.createElement('td');
                    td.textContent = value;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            
            table.appendChild(thead);
            table.appendChild(tbody);
            container.appendChild(table);
        }

        async function explainQuery() {
            const query = document.getElementById('queryInput').value;
            const aiPanel = document.getElementById('aiExplanation');
            const aiContent = document.getElementById('aiContent');
            
            aiPanel.classList.add('show');
            aiContent.textContent = 'Generating explanation...';
            
            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 500,
                        messages: [{
                            role: 'user',
                            content: `Explain this SQL query in simple terms: ${query}. Include what it does, which tables it uses, and the expected result.`
                        }],
                    }),
                });

                const data = await response.json();
                const text = data.content.map(item => item.text || '').join('\n');
                aiContent.textContent = text;
            } catch (err) {
                aiContent.textContent = 'Unable to connect to AI. This feature requires API setup. However, you can still run and visualize all SQL queries!';
            }
        }
    </script>
</body>
</html>